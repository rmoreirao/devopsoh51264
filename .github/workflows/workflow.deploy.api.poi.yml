name: "Deploy - api-poi (.NET Core)"

# run on push to main branch
on:
  push:
    branches:
      - main
    paths:
      - "apis/poi/**"
  workflow_dispatch:

# Set envs
env:
  WORKDIR: "apis/poi/web"
  DOCKER_IMAGE_BASE_NAME: "devopsoh/api-poi"
  API_NAME: "poi"
  RESOURCES_PREFIX: "${{ secrets.RESOURCES_PREFIX }}" # hardcoded or dynamic based on repo name

# Set defaults for GitHub Actions runner
defaults:
  run:
    working-directory: "apis/poi/web"

jobs:
  build:
    name: "Build"
    runs-on: ubuntu-latest
    # outputs:
    #   DOCKER_IMAGE_FULL_NAME: ${{ steps.dockerfullname.outputs.DOCKER_IMAGE_FULL_NAME }}
    steps:
      - uses: actions/checkout@v2

      # AZURE CONTAINER REGISTRY
      # - name: Get docker image full name
      #   run: |
      #     DOCKER_IMAGE_FULL_NAME=${{ secrets.RESOURCES_PREFIX }}cr.azurecr.io/${{ env.DOCKER_IMAGE_BASE_NAME }}

      #     # Set for current Job
      #     echo "DOCKER_IMAGE_FULL_NAME=${DOCKER_IMAGE_FULL_NAME}" >> ${GITHUB_ENV}

      #     # Set for next Job
      #     echo "::set-output name=DOCKER_IMAGE_FULL_NAME::${DOCKER_IMAGE_FULL_NAME}"
      #   id: dockerfullname

      - name: "Azure Login"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Build Docker image using Azure Container Registry"
        uses: Azure/cli@v1
        with:
          inlineScript: az acr build --image ${{ secrets.RESOURCES_PREFIX }}cr.azurecr.io/${{ env.DOCKER_IMAGE_BASE_NAME }}:${{ github.run_id }} --registry ${{ secrets.RESOURCES_PREFIX }}cr.azurecr.io --resource-group ${{ secrets.RESOURCES_PREFIX }}rg --build-arg build_version=${{ github.run_id }} --file ${{ env.WORKDIR }}/Dockerfile ${{ env.WORKDIR }}
  
  staging:
    name: "Staging (Blue)"
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: poi-staging
    env:
      RESOURCES_PREFIX: ${{ secrets.RESOURCES_PREFIX }}
      # DOCKER_IMAGE_FULL_NAME: "${{ needs.build.outputs.DOCKER_IMAGE_FULL_NAME }}"
    steps:
      # Login to Azure with Service Principal
      - name: "Azure Login"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Deploy to Staging"
        uses: Azure/cli@v1
        id: deploy-to-webapp
        with:
          inlineScript: az webapp config container set --name ${{ env.RESOURCES_PREFIX }}${{ env.API_NAME }} --slot staging --resource-group ${{ secrets.RESOURCES_PREFIX }}rg --docker-custom-image-name '${{ secrets.RESOURCES_PREFIX }}cr.azurecr.io/${{ env.DOCKER_IMAGE_BASE_NAME }}:${{ github.run_id }}' --docker-registry-server-url 'https://${{ secrets.RESOURCES_PREFIX }}cr.azurecr.io'

      - name: Check the deployed service health check
        uses: jtalk/url-health-check-action@v2
        with:
          url: https://${{ secrets.RESOURCES_PREFIX }}${{ env.API_NAME }}-staging.azurewebsites.net/api/healthcheck/${{ env.API_NAME }}
          follow-redirect: true
          max-attempts: 6
          retry-delay: 10s
          retry-all: true

  production:
    name: "Production (Red)"
    needs: staging
    runs-on: ubuntu-latest
    environment:
      name: poi-production
      url: "${{ steps.deploy-to-webapp.outputs.webapp-url }}/api/version/${{ env.API_NAME }}"
    env:
      RESOURCES_PREFIX: ${{ secrets.RESOURCES_PREFIX }}
      # DOCKER_IMAGE_FULL_NAME: "${{ needs.build.outputs.DOCKER_IMAGE_FULL_NAME }}"
    steps:
      # Login to Azure with Service Principal
      - name: "Azure Login"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Set new Docker image in WebApp
      # - name: Azure WebApp
      #   id: deploy-to-webapp
      #   uses: Azure/webapps-deploy@v2
      #   with:
      #     app-name: ${{ env.RESOURCES_PREFIX }}${{ env.API_NAME }}
      #     images: "${{ env.DOCKER_IMAGE_FULL_NAME }}:${{ github.run_id }}"
      - name: "Deploy to Production - Swap from Staging"
        uses: Azure/cli@v1
        id: deploy-to-webapp
        with:
          inlineScript: az webapp deployment slot swap  -g ${{ secrets.RESOURCES_PREFIX }}rg -n ${{ env.RESOURCES_PREFIX }}${{ env.API_NAME }} --slot staging --target-slot production

      - name: Check the deployed service health check
        uses: jtalk/url-health-check-action@v2
        with:
          url: https://${{ secrets.RESOURCES_PREFIX }}${{ env.API_NAME }}.azurewebsites.net/api/healthcheck/${{ env.API_NAME }}
          follow-redirect: true
          max-attempts: 6
          retry-delay: 10s
          retry-all: true